---
title: "Aula03 Analise Multivariada"
author: "Jonatas"
date: "9/4/2019"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)
library(haven)
library(ggplot2)
library(stargazer)
library(xtable)
pnad = read_sav("https://github.com/jonatasvarella/analisemultivariada/blob/master/PNAD2014_30a50_novo4.sav?raw=true")

```

### Lendo o Banco de dados

```{r include=F}
xtable(summary(pnad), caption = "Explorando o banco de dados")
```

\begin{table}[ht]
\tiny
\centering
\begin{tabular}{rlllllll}
  \hline
 &    anosesco &     isei88 &   isei88pai &     escpai &     escmãe &    lnrenda &     renda \\ 
  \hline
X & Min.   : 0.000   & Min.   :16.00   & Min.   :16.00   & Min.   : 0.000   & Min.   : 0.000   & Min.   : 3.689   & Min.   :    40.01   \\ 
  X.1 & 1st Qu.: 6.000   & 1st Qu.:27.00   & 1st Qu.:16.00   & 1st Qu.: 1.000   & 1st Qu.: 1.000   & 1st Qu.: 6.908   & 1st Qu.:  1000.01   \\ 
  X.2 & Median :11.000   & Median :30.00   & Median :29.00   & Median : 4.000   & Median : 4.000   & Median : 7.378   & Median :  1600.01   \\ 
  X.3 & Mean   : 9.347   & Mean   :38.91   & Mean   :30.98   & Mean   : 4.843   & Mean   : 4.889   & Mean   : 7.483   & Mean   :  2818.55   \\ 
  X.4 & 3rd Qu.:12.000   & 3rd Qu.:51.00   & 3rd Qu.:34.00   & 3rd Qu.: 8.000   & 3rd Qu.: 8.000   & 3rd Qu.: 8.006   & 3rd Qu.:  3000.01   \\ 
  X.5 & Max.   :16.000   & Max.   :90.00   & Max.   :90.00   & Max.   :16.000   & Max.   :16.000   & Max.   :11.695   & Max.   :120000.01   \\ 
   \hline
\end{tabular}
\caption{Explorando o banco de dados} 
\end{table}


### Análise I

```{r 2, include=FALSE}
t1 = summary(pnad$isei88)      #média de y
t2 = summary(pnad$isei88pai)   #média de x
t(t1)
xtable(t(t1), caption = "Média de Y (ISEI da ocupação)")
xtable(t(t2), caption = "Média de X (ISEI da ocupação do pai)")
```
\begin{table}[ht]
\centering
\begin{tabular}{rrrrrrr}
  \hline
 & Min. & 1st Qu. & Median & Mean & 3rd Qu. & Max. \\ 
  \hline
1 & 16.00 & 27.00 & 30.00 & 38.91 & 51.00 & 90.00 \\ 
   \hline
\end{tabular}
\caption{Média de Y (ISEI da ocupação)} 
\end{table}

\begin{table}[ht]
\centering
\begin{tabular}{rrrrrrr}
  \hline
 & Min. & 1st Qu. & Median & Mean & 3rd Qu. & Max. \\ 
  \hline
1 & 16.00 & 16.00 & 29.00 & 30.98 & 34.00 & 90.00 \\ 
   \hline
\end{tabular}
\caption{Média de X (ISEI da ocupação do pai)} 
\end{table}

### Modelo I
```{r 3, include=F}
reg = lm(isei88 ~ isei88pai, data=pnad)
stargazer(reg, title = "Resultados - Modelo I")
```

\begin{table}[!htbp]
  \small
  \centering 
  \caption{Resultados - Modelo I} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & isei88 \\ 
\hline \\[-1.8ex] 
 isei88pai & 0.477$^{***}$ \\ 
  & (0.014) \\ 
  & \\ 
 Constant & 24.128$^{***}$ \\ 
  & (0.506) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 4,383 \\ 
R$^{2}$ & 0.203 \\ 
Adjusted R$^{2}$ & 0.203 \\ 
Residual Std. Error & 16.342 (df = 4381) \\ 
F Statistic & 1,118.733$^{***}$ (df = 1; 4381) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 



### Anova I

```{r 4, include=FALSE}
xtable(anova(reg), caption = "Anova I")
```

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrr}
  \hline
 & Df & Sum Sq & Mean Sq & F value & Pr($>$F) \\ 
  \hline
isei88pai & 1 & 298787.62 & 298787.62 & 1118.73 & 0.0000 \\ 
  Residuals & 4381 & 1170062.96 & 267.08 &  &  \\ 
   \hline
\end{tabular}
\caption{Anova I} 
\end{table}

### Histograma I

```{r}
zresid <- scale(resid(reg))
#hist(zresid)
hist_with_normal_curve <- function(x, breaks = 24) {
    h <- hist(zresid, breaks = breaks, col = "lightblue")
    xfit <- seq(min(x), max(x), length = 40)
    yfit <- dnorm(xfit, mean = mean(x), sd = sd(x))
    yfit <- yfit * diff(h$mids[1:2]) * length(x)
    lines(xfit, yfit, lwd = 2)
}
hist_with_normal_curve(zresid)
```

### gráficos de avaliação I

```{r}
par(mfrow=c(2,2))
plot(reg)
```

### Análise II

```{r , include=F}
reg2 = lm( renda ~ isei88, data=pnad)
stargazer(reg2, title = "Resultados - Modelo II")
```

\begin{table}[!htbp] \centering
\small
  \caption{Resultados - Modelo II} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & renda \\ 
\hline \\[-1.8ex] 
 isei88 & 99.373$^{***}$ \\ 
  & (3.631) \\ 
  & \\ 
 Constant & $-$1,048.060$^{***}$ \\ 
  & (156.121) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 4,383 \\ 
R$^{2}$ & 0.146 \\ 
Adjusted R$^{2}$ & 0.146 \\ 
Residual Std. Error & 4,400.138 (df = 4381) \\ 
F Statistic & 749.171$^{***}$ (df = 1; 4381) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

### Anova II

```{r , include=FALSE}
xtable(anova(reg2), caption = "Anova II")
```

\begin{table}[ht]
\small
\centering
\begin{tabular}{lrrrrr}
  \hline
 & Df & Sum Sq & Mean Sq & F value & Pr($>$F) \\ 
  \hline
isei88 & 1 & 14504870191.64 & 14504870191.64 & 749.17 & 0.0000 \\ 
  Residuals & 4381 & 84821486588.67 & 19361215.84 &  &  \\ 
   \hline
\end{tabular}
\caption{Anova II} 
\end{table}

### Histograma

```{r}
zresid2 <- scale(resid(reg2))
#hist(zresid)
hist_with_normal_curve <- function(x, breaks = 24) {
    h <- hist(zresid2, breaks = breaks, col = "lightblue")
    xfit <- seq(min(x), max(x), length = 40)
    yfit <- dnorm(xfit, mean = mean(x), sd = sd(x))
    yfit <- yfit * diff(h$mids[1:2]) * length(x)
    lines(xfit, yfit, lwd = 2)
}
hist_with_normal_curve(zresid2)
```

### Gráficos de avaliação II

```{r}
par(mfrow=c(2,2))
plot(reg2)
```

### Análise III

```{r , include=F}
reg3 = lm( lnrenda ~ isei88, data=pnad)
stargazer(reg3, title = "Resultados - Modelo III")
```

\begin{table}[!htbp] \centering
\small
  \caption{Resultados - Modelo III} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & lnrenda \\ 
\hline \\[-1.8ex] 
 isei88 & 0.029$^{***}$ \\ 
  & (0.001) \\ 
  & \\ 
 Constant & 6.348$^{***}$ \\ 
  & (0.025) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 4,383 \\ 
R$^{2}$ & 0.359 \\ 
Adjusted R$^{2}$ & 0.359 \\ 
Residual Std. Error & 0.714 (df = 4381) \\ 
F Statistic & 2,458.062$^{***}$ (df = 1; 4381) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

### Anova III

```{r , include=FALSE}
xtable(anova(reg3), caption = "Anova III")
```

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrr}
  \hline
 & Df & Sum Sq & Mean Sq & F value & Pr($>$F) \\ 
  \hline
isei88 & 1 & 1251.45 & 1251.45 & 2458.06 & 0.0000 \\ 
  Residuals & 4381 & 2230.45 & 0.51 &  &  \\ 
   \hline
\end{tabular}
\caption{Anova III} 
\end{table}

### Histograma

```{r}
zresid3 <- scale(resid(reg3))
#hist(zresid)
hist_with_normal_curve <- function(x, breaks = 24) {
    h <- hist(zresid3, breaks = breaks, col = "lightblue")
    xfit <- seq(min(x), max(x), length = 40)
    yfit <- dnorm(xfit, mean = mean(x), sd = sd(x))
    yfit <- yfit * diff(h$mids[1:2]) * length(x)
    lines(xfit, yfit, lwd = 2)
}
hist_with_normal_curve(zresid3)
```

### Gráficos de avaliação III

```{r}
par(mfrow=c(2,2))
plot(reg3)
```

### Análise IV

```{r echo=T}
## Criando o logaritmo da variável isei88
pnad$lnisei88 = log(pnad$isei88)
```

### Modelo IV
```{r , include=F}
reg4= lm(lnrenda ~ lnisei88, data=pnad)
stargazer(reg4, title = "Resultados - Modelo IV")
```

\begin{table}[!htbp] \centering 
\small
  \caption{Resultados - Modelo IV} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & lnrenda \\ 
\hline \\[-1.8ex] 
 lnisei88 & 1.180$^{***}$ \\ 
  & (0.024) \\ 
  & \\ 
 Constant & 3.285$^{***}$ \\ 
  & (0.084) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 4,383 \\ 
R$^{2}$ & 0.365 \\ 
Adjusted R$^{2}$ & 0.365 \\ 
Residual Std. Error & 0.710 (df = 4381) \\ 
F Statistic & 2,517.178$^{***}$ (df = 1; 4381) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

### Anova IV

```{r , include=FALSE}
xtable(anova(reg4), caption = "Anova IV")
```

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrr}
  \hline
 & Df & Sum Sq & Mean Sq & F value & Pr($>$F) \\ 
  \hline
lnisei88 & 1 & 1270.56 & 1270.56 & 2517.18 & 0.0000 \\ 
  Residuals & 4381 & 2211.34 & 0.50 &  &  \\ 
   \hline
\end{tabular}
\caption{Anova IV} 
\end{table}

### Histograma IV

```{r}
zresid4 <- scale(resid(reg4))
#hist(zresid)
hist_with_normal_curve <- function(x, breaks = 24) {
    h <- hist(zresid4, breaks = breaks, col = "lightblue")
    xfit <- seq(min(x), max(x), length = 40)
    yfit <- dnorm(xfit, mean = mean(x), sd = sd(x))
    yfit <- yfit * diff(h$mids[1:2]) * length(x)
    lines(xfit, yfit, lwd = 2)
}
hist_with_normal_curve(zresid4)
```

### Gráficos de avaliação IV

```{r}
par(mfrow=c(2,2))
plot(reg4)
```


### Análise V

```{r ,echo=T}
## Padronizando as variáveis
pnad_pad = data.frame(Y = pnad$isei88, X = pnad$anosesco)
pnad_pad$Y= (pnad_pad$Y -mean(pnad_pad$Y)) /sd(pnad_pad$Y)
pnad_pad$X= (pnad_pad$X -mean(pnad_pad$X)) /sd(pnad_pad$X)
```

### Modelo V

```{r , include=F}
reg_pad = lm(Y ~ X, data = pnad_pad)
stargazer(reg_pad, title = "Resultados - Modelo V (Padronizado)")
```

\begin{table}[!htbp] \centering 
\small
  \caption{Resultados - Modelo V (Padronizado)} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & Y \\ 
\hline \\[-1.8ex] 
 X & 0.584$^{***}$ \\ 
  & (0.012) \\ 
  & \\ 
 Constant & 0.000 \\ 
  & (0.012) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 4,383 \\ 
R$^{2}$ & 0.341 \\ 
Adjusted R$^{2}$ & 0.341 \\ 
Residual Std. Error & 0.812 (df = 4381) \\ 
F Statistic & 2,264.319$^{***}$ (df = 1; 4381) \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table}

### Anova V

```{r , include=FALSE}
xtable(anova(reg_pad), caption = "Anova V (Padronizado)")
```

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrr}
  \hline
 & Df & Sum Sq & Mean Sq & F value & Pr($>$F) \\ 
  \hline
X & 1 & 1493.12 & 1493.12 & 2264.32 & 0.0000 \\ 
  Residuals & 4381 & 2888.88 & 0.66 &  &  \\ 
   \hline
\end{tabular}
\caption{Anova V (Padronizado)} 
\end{table}

### Histograma V

```{r}
zresid5 <- scale(resid(reg_pad))
#hist(zresid)
hist_with_normal_curve <- function(x, breaks = 24) {
    h <- hist(zresid5, breaks = breaks, col = "lightblue")
    xfit <- seq(min(x), max(x), length = 40)
    yfit <- dnorm(xfit, mean = mean(x), sd = sd(x))
    yfit <- yfit * diff(h$mids[1:2]) * length(x)
    lines(xfit, yfit, lwd = 2)
}
hist_with_normal_curve(zresid5)
```

### Gráficos de avaliação V

```{r}
par(mfrow=c(2,2))
plot(reg_pad)
```


### Modelos

```{r , include=F}
library(texreg)
texreg(list(reg, reg2, reg3, reg4, reg_pad), title = "Modelos Analisados")
```

\begin{table}
\small
\begin{center}
\begin{tabular}{l c c c c c }
\hline
 & Model 1 & Model 2 & Model 3 & Model 4 & Model 5 \\
\hline
(Intercept) & $24.13^{***}$ & $-1048.06^{***}$ & $6.35^{***}$ & $3.29^{***}$ & $0.00$       \\
            & $(0.51)$      & $(156.12)$       & $(0.03)$     & $(0.08)$     & $(0.01)$     \\
isei88pai   & $0.48^{***}$  &                  &              &              &              \\
            & $(0.01)$      &                  &              &              &              \\
isei88      &               & $99.37^{***}$    & $0.03^{***}$ &              &              \\
            &               & $(3.63)$         & $(0.00)$     &              &              \\
lnisei88    &               &                  &              & $1.18^{***}$ &              \\
            &               &                  &              & $(0.02)$     &              \\
X           &               &                  &              &              & $0.58^{***}$ \\
            &               &                  &              &              & $(0.01)$     \\
\hline
R$^2$       & 0.20          & 0.15             & 0.36         & 0.36         & 0.34         \\
Adj. R$^2$  & 0.20          & 0.15             & 0.36         & 0.36         & 0.34         \\
Num. obs.   & 4383          & 4383             & 4383         & 4383         & 4383         \\
RMSE        & 16.34         & 4400.14          & 0.71         & 0.71         & 0.81         \\
\hline
\multicolumn{6}{l}{\scriptsize{$^{***}p<0.001$, $^{**}p<0.01$, $^*p<0.05$}}
\end{tabular}
\caption{Statistical models}
\label{table:coefficients}
\end{center}
\end{table}
